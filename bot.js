// Ð¤Ð°Ð¹Ð» bot.js
// ÐŸÑ€Ð¾ÑÑ‚Ð¾Ð¹ Telegram Ð±Ð¾Ñ‚ Ð´Ð»Ñ NeighborHelp
// Ð­Ñ‚Ð¾Ñ‚ Ñ„Ð°Ð¹Ð» Ð¼Ð¾Ð¶Ð½Ð¾ Ñ€Ð°Ð·Ð¼ÐµÑÑ‚Ð¸Ñ‚ÑŒ Ð½Ð° Ð±ÐµÑÐ¿Ð»Ð°Ñ‚Ð½Ð¾Ð¼ Ñ…Ð¾ÑÑ‚Ð¸Ð½Ð³Ðµ

const TelegramBot = require('node-telegram-bot-api');

// Ð—Ð°Ð¼ÐµÐ½Ð¸Ñ‚Ðµ Ð½Ð° Ð²Ð°Ñˆ Ñ‚Ð¾ÐºÐµÐ½ Ð¾Ñ‚ BotFather
const BOT_TOKEN = process.env.BOT_TOKEN || 'demo_mode';
const bot = new TelegramBot(BOT_TOKEN, {polling: true});

// URL Ð²Ð°ÑˆÐµÐ³Ð¾ Mini App
const MINI_APP_URL = 'https://helppps.github.io/neighborhelp-app/';

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /start
bot.onText(/\/start/, (msg) => {
    const chatId = msg.chat.id;
    const firstName = msg.from.first_name || 'Ð”Ñ€ÑƒÐ³';
    
    const welcomeMessage = `
ðŸ  Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ Ð² NeighborHelp, ${firstName}!

Ð—Ð´ÐµÑÑŒ Ð²Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ Ð½Ð°Ð¹Ñ‚Ð¸ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒ Ð¾Ñ‚ ÑÐ¾ÑÐµÐ´ÐµÐ¹ Ð¸Ð»Ð¸ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶Ð¸Ñ‚ÑŒ ÑÐ²Ð¾Ð¸ ÑƒÑÐ»ÑƒÐ³Ð¸.

ðŸ”¥ Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸:
ðŸ• Ð–Ð¸Ð²Ð¾Ñ‚Ð½Ñ‹Ðµ (Ð²Ñ‹Ð³ÑƒÐ», Ð¿ÐµÑ€ÐµÐ´ÐµÑ€Ð¶ÐºÐ°)
ðŸ“¦ Ð”Ð¾ÑÑ‚Ð°Ð²ÐºÐ° (Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ñ‹, Ð»ÐµÐºÐ°Ñ€ÑÑ‚Ð²Ð°) 
ðŸ  Ð”Ð¾Ð¼ Ð¸ Ð±Ñ‹Ñ‚ (Ñ€ÐµÐ¼Ð¾Ð½Ñ‚, ÑƒÐ±Ð¾Ñ€ÐºÐ°)
ðŸ‘´ ÐŸÐ¾Ð¼Ð¾Ñ‰ÑŒ Ð¿Ð¾Ð¶Ð¸Ð»Ñ‹Ð¼
ðŸš— Ð¢Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚ (Ð¿Ð¾ÐµÐ·Ð´ÐºÐ¸, Ð¿ÐµÑ€ÐµÐ²Ð¾Ð·ÐºÐ¸)
ðŸ’» IT-ÑƒÑÐ»ÑƒÐ³Ð¸

ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ ÐºÐ½Ð¾Ð¿ÐºÑƒ Ð½Ð¸Ð¶Ðµ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ! ðŸ‘‡
    `;
    
    const options = {
        reply_markup: {
            inline_keyboard: [
                [
                    {
                        text: 'ðŸ  ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ NeighborHelp',
                        web_app: { url: MINI_APP_URL }
                    }
                ],
                [
                    { text: 'â“ ÐŸÐ¾Ð¼Ð¾Ñ‰ÑŒ', callback_data: 'help' },
                    { text: 'ðŸ“ž ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ°', callback_data: 'support' }
                ]
            ]
        }
    };
    
    bot.sendMessage(chatId, welcomeMessage, options);
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¾Ñ‚ Mini App
bot.on('web_app_data', (msg) => {
    const chatId = msg.chat.id;
    const data = JSON.parse(msg.web_app.data);
    
    console.log('ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¾Ñ‚ Mini App:', data);
    
    // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ñ€Ð°Ð·Ð»Ð¸Ñ‡Ð½Ñ‹Ñ… Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¹
    switch(data.action) {
        case 'contact_provider':
            handleContactProvider(chatId, data);
            break;
        case 'add_service':
            handleAddService(chatId, data);
            break;
        default:
            bot.sendMessage(chatId, 'âœ… Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ñ‹!');
    }
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÑÐ²ÑÐ·Ð¸ Ñ Ð¸ÑÐ¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÐµÐ¼
function handleContactProvider(chatId, data) {
    const message = `
ðŸ¤ Ð—Ð°Ð¿Ñ€Ð¾Ñ Ð½Ð° ÑƒÑÐ»ÑƒÐ³Ñƒ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½!

ðŸ“‹ Ð£ÑÐ»ÑƒÐ³Ð°: ${data.service_title || 'ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð¾'}
ðŸ‘¤ Ð˜ÑÐ¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒ: ${data.provider_contact || 'ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð¾'}

ðŸ’¬ Ð’Ð°ÑˆÐµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¿ÐµÑ€ÐµÐ´Ð°Ð½Ð¾ Ð¸ÑÐ¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŽ. 
ÐžÐ¶Ð¸Ð´Ð°Ð¹Ñ‚Ðµ Ð¾Ñ‚Ð²ÐµÑ‚Ð° Ð² Ñ‚ÐµÑ‡ÐµÐ½Ð¸Ðµ 15 Ð¼Ð¸Ð½ÑƒÑ‚.

Ð•ÑÐ»Ð¸ Ð¸ÑÐ¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒ Ð½Ðµ Ð¾Ñ‚Ð²ÐµÑ‚Ð¸Ñ‚, Ð¼Ñ‹ Ð½Ð°Ð¹Ð´ÐµÐ¼ Ð²Ð°Ð¼ Ð°Ð»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²Ñ‹! ðŸ”„
    `;
    
    bot.sendMessage(chatId, message);
    
    // Ð—Ð´ÐµÑÑŒ Ð¼Ð¾Ð¶Ð½Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð»Ð¾Ð³Ð¸ÐºÑƒ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ð¸ÑÐ¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»Ñ
    console.log(`ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ${chatId} Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¸Ð» ÑƒÑÐ»ÑƒÐ³Ñƒ:`, data);
}

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ñ ÑƒÑÐ»ÑƒÐ³Ð¸
function handleAddService(chatId, data) {
    const message = `
âœ… Ð’Ð°ÑˆÐ° ÑƒÑÐ»ÑƒÐ³Ð° Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð° Ð½Ð° Ð¼Ð¾Ð´ÐµÑ€Ð°Ñ†Ð¸ÑŽ!

ðŸ“ ÐœÑ‹ Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¸Ð¼ Ð¾Ð±ÑŠÑÐ²Ð»ÐµÐ½Ð¸Ðµ Ð² Ñ‚ÐµÑ‡ÐµÐ½Ð¸Ðµ 2 Ñ‡Ð°ÑÐ¾Ð².
ðŸ“¢ ÐŸÐ¾ÑÐ»Ðµ Ð¾Ð´Ð¾Ð±Ñ€ÐµÐ½Ð¸Ñ Ð¾Ð½Ð¾ Ð¿Ð¾ÑÐ²Ð¸Ñ‚ÑÑ Ð² Ð¾Ð±Ñ‰ÐµÐ¼ ÑÐ¿Ð¸ÑÐºÐµ.

Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾ Ð·Ð° ÑƒÑ‡Ð°ÑÑ‚Ð¸Ðµ Ð² Ñ€Ð°Ð·Ð²Ð¸Ñ‚Ð¸Ð¸ ÑÐ¾Ð¾Ð±Ñ‰ÐµÑÑ‚Ð²Ð°! ðŸ¤—
    `;
    
    bot.sendMessage(chatId, message);
    
    // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ ÑƒÑÐ»ÑƒÐ³Ð¸ (Ð·Ð´ÐµÑÑŒ Ð¼Ð¾Ð¶Ð½Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð±Ð°Ð·Ñƒ Ð´Ð°Ð½Ð½Ñ‹Ñ…)
    console.log(`ÐÐ¾Ð²Ð°Ñ ÑƒÑÐ»ÑƒÐ³Ð° Ð¾Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ ${chatId}:`, data);
}

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÐºÐ½Ð¾Ð¿Ð¾Ðº
bot.on('callback_query', (callbackQuery) => {
    const chatId = callbackQuery.message.chat.id;
    const data = callbackQuery.data;
    
    switch(data) {
        case 'help':
            const helpMessage = `
â“ ÐšÐ°Ðº Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ NeighborHelp:

1ï¸âƒ£ ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ "ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ NeighborHelp"
2ï¸âƒ£ Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð½ÑƒÐ¶Ð½ÑƒÑŽ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸ÑŽ ÑƒÑÐ»ÑƒÐ³
3ï¸âƒ£ ÐÐ°Ð¹Ð´Ð¸Ñ‚Ðµ Ð¿Ð¾Ð´Ñ…Ð¾Ð´ÑÑ‰ÐµÐµ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
4ï¸âƒ£ ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ Ð½Ð° ÑƒÑÐ»ÑƒÐ³Ñƒ Ð´Ð»Ñ ÑÐ²ÑÐ·Ð¸
5ï¸âƒ£ Ð”Ð¾Ð³Ð¾Ð²Ð¾Ñ€Ð¸Ñ‚ÐµÑÑŒ Ð¾Ð± ÑƒÑÐ»Ð¾Ð²Ð¸ÑÑ…

ðŸ’¡ Ð¡Ð¾Ð²ÐµÑ‚Ñ‹:
â€¢ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐ¹Ñ‚Ðµ Ñ€ÐµÐ¹Ñ‚Ð¸Ð½Ð³ Ð¸ÑÐ¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÐµÐ¹
â€¢ Ð£Ñ‚Ð¾Ñ‡Ð½ÑÐ¹Ñ‚Ðµ Ð´ÐµÑ‚Ð°Ð»Ð¸ Ð´Ð¾ Ð²ÑÑ‚Ñ€ÐµÑ‡Ð¸
â€¢ ÐžÐ¿Ð»Ð°Ñ‡Ð¸Ð²Ð°Ð¹Ñ‚Ðµ Ð¿Ð¾ÑÐ»Ðµ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ
â€¢ ÐžÑÑ‚Ð°Ð²Ð»ÑÐ¹Ñ‚Ðµ Ð¾Ñ‚Ð·Ñ‹Ð²Ñ‹

ðŸ”’ Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ:
â€¢ ÐÐµ Ð¿ÐµÑ€ÐµÐ´Ð°Ð²Ð°Ð¹Ñ‚Ðµ Ð»Ð¸Ñ‡Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ
â€¢ Ð’ÑÑ‚Ñ€ÐµÑ‡Ð°Ð¹Ñ‚ÐµÑÑŒ Ð² Ð¾Ð±Ñ‰ÐµÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ñ… Ð¼ÐµÑÑ‚Ð°Ñ…
â€¢ Ð”Ð¾Ð²ÐµÑ€ÑÐ¹Ñ‚Ðµ ÑÐ²Ð¾ÐµÐ¹ Ð¸Ð½Ñ‚ÑƒÐ¸Ñ†Ð¸Ð¸
            `;
            bot.sendMessage(chatId, helpMessage);
            break;
            
        case 'support':
            const supportMessage = `
ðŸ“ž ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° NeighborHelp

ðŸ• Ð§Ð°ÑÑ‹ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹: 9:00 - 21:00 (ÐœÐ¡Ðš)
ðŸ“§ Email: support@neighborhelp.ru
ðŸ’¬ Telegram: @neighborhelp_support

âš¡ Ð­ÐºÑÑ‚Ñ€ÐµÐ½Ð½Ñ‹Ðµ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹ - Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ ÑÑ€Ð°Ð·Ñƒ!
ðŸ¤ ÐœÑ‹ Ð¿Ð¾Ð¼Ð¾Ð¶ÐµÐ¼ Ñ€ÐµÑˆÐ¸Ñ‚ÑŒ Ð»ÑŽÐ±ÑƒÑŽ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñƒ.

Ð’Ð°ÑˆÐ° Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ - Ð½Ð°Ñˆ Ð¿Ñ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚! ðŸ›¡ï¸
            `;
            bot.sendMessage(chatId, supportMessage);
            break;
    }
    
    // Ð£Ð±Ð¸Ñ€Ð°ÐµÐ¼ "Ñ‡Ð°ÑÐ¸ÐºÐ¸" Ñ ÐºÐ½Ð¾Ð¿ÐºÐ¸
    bot.answerCallbackQuery(callbackQuery.id);
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾Ð±Ñ‹Ñ‡Ð½Ñ‹Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹
bot.on('message', (msg) => {
    if (msg.text && !msg.text.startsWith('/')) {
        const chatId = msg.chat.id;
        const response = `
ÐŸÑ€Ð¸Ð²ÐµÑ‚! ðŸ‘‹ 

Ð”Ð»Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ NeighborHelp Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ ÐºÐ½Ð¾Ð¿ÐºÑƒ "ðŸ  ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ NeighborHelp" Ð¸Ð»Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ /start

ðŸš€ Ð’ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ð¸ Ð²Ð°Ñ Ð¶Ð´ÑƒÑ‚:
â€¢ Ð¡Ð¾Ñ‚Ð½Ð¸ ÑƒÑÐ»ÑƒÐ³ Ð¾Ñ‚ ÑÐ¾ÑÐµÐ´ÐµÐ¹
â€¢ Ð£Ð´Ð¾Ð±Ð½Ñ‹Ð¹ Ð¿Ð¾Ð¸ÑÐº Ð¿Ð¾ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸ÑÐ¼  
â€¢ Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ñ‹Ðµ ÑÐ´ÐµÐ»ÐºÐ¸
â€¢ Ð‘Ñ‹ÑÑ‚Ñ€Ð°Ñ ÑÐ²ÑÐ·ÑŒ Ñ Ð¸ÑÐ¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑÐ¼Ð¸
        `;
        
        const options = {
            reply_markup: {
                inline_keyboard: [
                    [
                        {
                            text: 'ðŸ  ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ NeighborHelp',
                            web_app: { url: MINI_APP_URL }
                        }
                    ]
                ]
            }
        };
        
        bot.sendMessage(chatId, response, options);
    }
});

// Ð›Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¾ÑˆÐ¸Ð±Ð¾Ðº
bot.on('error', (error) => {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð±Ð¾Ñ‚Ð°:', error);
});

console.log('ðŸ¤– NeighborHelp Ð±Ð¾Ñ‚ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½!');
console.log('ðŸ“± Mini App URL:', MINI_APP_URL);